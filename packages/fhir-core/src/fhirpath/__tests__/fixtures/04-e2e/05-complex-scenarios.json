{
  "description": "End-to-end: Complex real-world FHIRPath scenarios with chained operations",
  "tests": [
    {
      "description": "Find official name formatted as 'Given Family'",
      "resource": {
        "resourceType": "Patient",
        "name": [
          { "use": "official", "family": "Johnson", "given": ["Robert", "Lee"] },
          { "use": "nickname", "given": ["Bobby"] }
        ]
      },
      "expression": "Patient.name.where(use = 'official').select(given.first() & ' ' & family).first()",
      "expected": ["Robert Johnson"]
    },
    {
      "description": "Count active patients in bundle",
      "resource": {
        "resourceType": "Bundle",
        "type": "searchset",
        "entry": [
          { "resource": { "resourceType": "Patient", "id": "p1", "active": true, "name": [{"family": "A"}] } },
          { "resource": { "resourceType": "Patient", "id": "p2", "active": false, "name": [{"family": "B"}] } },
          { "resource": { "resourceType": "Patient", "id": "p3", "active": true, "name": [{"family": "C"}] } }
        ]
      },
      "expression": "Bundle.entry.resource.ofType(Patient).where(active = true).count()",
      "expected": [2]
    },
    {
      "description": "Get all family names from bundle",
      "resource": {
        "resourceType": "Bundle",
        "type": "searchset",
        "entry": [
          { "resource": { "resourceType": "Patient", "id": "p1", "name": [{"family": "Alpha"}] } },
          { "resource": { "resourceType": "Patient", "id": "p2", "name": [{"family": "Beta"}] } }
        ]
      },
      "expression": "Bundle.entry.resource.ofType(Patient).name.family",
      "expected": ["Alpha", "Beta"]
    },
    {
      "description": "Check observation has vital-signs category",
      "resource": {
        "resourceType": "Observation",
        "status": "final",
        "category": [
          { "coding": [{ "system": "http://terminology.hl7.org/CodeSystem/observation-category", "code": "vital-signs" }] }
        ],
        "code": { "text": "BP" }
      },
      "expression": "Observation.category.coding.where(code = 'vital-signs').exists()",
      "expected": [true]
    },
    {
      "description": "Filter telecom by system and use",
      "resource": {
        "resourceType": "Patient",
        "telecom": [
          { "system": "phone", "value": "555-HOME", "use": "home" },
          { "system": "phone", "value": "555-WORK", "use": "work" },
          { "system": "email", "value": "test@test.com", "use": "home" }
        ]
      },
      "expression": "Patient.telecom.where(system = 'phone' and use = 'home').value",
      "expected": ["555-HOME"]
    },
    {
      "description": "Nested iif conditional",
      "resource": { "resourceType": "Patient", "active": true, "gender": "female" },
      "expression": "iif(Patient.active, iif(Patient.gender = 'female', 'Active Female', 'Active Other'), 'Inactive')",
      "expected": ["Active Female"]
    },
    {
      "description": "String operations on address",
      "resource": {
        "resourceType": "Patient",
        "address": [{ "city": "New York", "state": "NY", "postalCode": "10001" }]
      },
      "expression": "Patient.address.first().city.upper() & ', ' & Patient.address.first().state",
      "expected": ["NEW YORK, NY"]
    },
    {
      "description": "Distinct given names across all name entries",
      "resource": {
        "resourceType": "Patient",
        "name": [
          { "given": ["John", "Michael"] },
          { "given": ["John", "James"] }
        ]
      },
      "expression": "Patient.name.given.distinct().count()",
      "expected": [3]
    }
  ]
}
