```flowchart TD
    A([START<br/>调用 generateSnapshot]) --> B{derived<br/>是否包含 differential?}

    B -- 否 --> E1[抛出 DefinitionException<br/>无 differential]
    B -- 是 --> C{base 是否存在?}

    C -- 否 --> E2[抛出 DefinitionException<br/>baseDefinition 无法解析]
    C -- 是 --> D{base.snapshot 是否存在?}

    D -- 否 --> R[递归调用 generateSnapshot<br/>生成 base.snapshot]
    R --> D
    D -- 是 --> E[初始化 dst.snapshot<br/>clone base.snapshot.element]

    E --> F[遍历 derived.differential.element<br/>(顺序敏感)]

    F --> G{能否在 snapshot 中<br/>找到对应 path?}
    G -- 否 --> E3[抛出 DefinitionException<br/>非法 path]
    G -- 是 --> H{path 是否为 choice[x]?}

    H -- 是 --> I[展开所有 choice 子元素<br/>标记不匹配 type 的元素]
    H -- 否 --> J{是否声明 slicing?}

    I --> J
    J -- 是 --> K[将 slicing 附加到目标 element]
    J -- 否 --> L{是否为 slice 元素<br/>(包含 sliceName)?}

    K --> L
    L -- 是 --> M{是否已有 slicing 声明?}
    M -- 否 --> E4[抛出 DefinitionException<br/>slice 在 slicing 前]
    M -- 是 --> N[clone base element<br/>设置 sliceName<br/>合并 differential<br/>插入 snapshot]

    L -- 否 --> O[clone base element<br/>合并 differential<br/>替换 snapshot 中元素]

    N --> P{是否为 extension 路径?}
    O --> P

    P -- 是 --> Q[执行 extension 特殊 slicing 处理]
    P -- 否 --> S[继续下一个 differential element]

    Q --> S
    S --> F

    F -->|遍历完成| T[清理 choice 遗留节点<br/>删除被标记的元素]

    T --> U[Snapshot 完整性校验<br/>path / slicing / 结构]

    U --> V{校验是否通过?}
    V -- 否 --> E5[抛出 FHIRException]
    V -- 是 --> W([END<br/>snapshot 生成完成])

```
