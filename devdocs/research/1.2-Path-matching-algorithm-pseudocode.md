下面这一份就是 **HAPI SnapshotGenerator → `processPaths()` 的 Path Matching Algorithm 伪代码**，**结构、顺序、判错点都对齐真实实现思路**，可以直接作为 Stage-1 文档或实现蓝本。

---

## **Deliverable: Path Matching Algorithm – Pseudocode**

### **Overall Entry**

```pseudo
function processPaths(baseSnapshot, differential):
    snapshot = deepClone(baseSnapshot)

    for diffElem in differential.elements:
        applyDifferentialElement(snapshot, diffElem)

    return snapshot
```

---

### **Apply One Differential Element**

```pseudo
function applyDifferentialElement(snapshot, diffElem):

    match = findMatchingElement(snapshot, diffElem)

    if match != null:
        merged = mergeConstraints(match, diffElem)
        snapshot[match.index] = merged
        return

    if canInsertNewElement(snapshot, diffElem):
        insertIndex = findInsertionIndex(snapshot, diffElem)
        snapshot.insert(insertIndex, diffElem)
        return

    throw Error("No matching base element for path: " + diffElem.path)
```

---

### **Path Matching Logic**

```pseudo
function findMatchingElement(snapshot, diffElem):

    for i from 0 to snapshot.length - 1:
        baseElem = snapshot[i]

        if baseElem.path != diffElem.path:
            continue

        if sliceNameMatches(baseElem, diffElem):
            return { element: baseElem, index: i }

    return null
```

---

### **Slice Name Matching**

```pseudo
function sliceNameMatches(baseElem, diffElem):

    if diffElem.sliceName is null:
        return true

    return baseElem.sliceName == diffElem.sliceName
```

---

### **Insertability Check**

```pseudo
function canInsertNewElement(snapshot, diffElem):

    parentPath = getParentPath(diffElem.path)

    for elem in snapshot:
        if elem.path == parentPath:
            return true

    return false
```

---

### **Insertion Index Resolution**

```pseudo
function findInsertionIndex(snapshot, diffElem):

    parentPath = getParentPath(diffElem.path)
    lastChildIndex = -1
    parentIndex = -1

    for i from 0 to snapshot.length - 1:
        elem = snapshot[i]

        if elem.path == parentPath:
            parentIndex = i

        if elem.path startsWith parentPath + ".":
            lastChildIndex = i

    if lastChildIndex != -1:
        return lastChildIndex + 1

    return parentIndex + 1
```

---

### **Constraint Merge Semantics**

```pseudo
function mergeConstraints(baseElem, diffElem):

    result = clone(baseElem)

    for each field in diffElem:
        if field is defined:
            result.field = diffElem.field

    return result
```

---

### **Utility: Parent Path Resolution**

```pseudo
function getParentPath(path):

    if path does not contain ".":
        return null

    return substring(path before last ".")
```

---

## ✅ **Algorithm Guarantees**

- **Exact path match only** (no fuzzy / regex matching)
- **Slice-aware** (path + sliceName jointly唯一)
- **Order-preserving snapshot**
- **No implicit element creation**
- **Strict error on illegal differential**

---
